<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng | E-Learning Platform</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .page-title {
            font-size: var(--font-size-h1);
            font-weight: 600;
            color: var(--dark-gray);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .filters-section {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-light);
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 200px 200px auto;
            gap: var(--spacing-md);
            align-items: end;
        }

        .table-container {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .table-header {
            background: var(--light-gray);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .table-count {
            font-size: var(--font-size-small);
            color: #666;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: var(--light-gray);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            color: var(--dark-gray);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .users-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .users-table tr:hover {
            background: rgba(44, 110, 170, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        .user-email {
            font-size: var(--font-size-small);
            color: #666;
        }

        .role-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-small);
            font-weight: 500;
            text-transform: capitalize;
        }

        .role-badge.student {
            background: rgba(44, 110, 170, 0.1);
            color: var(--primary-blue);
        }

        .role-badge.teacher {
            background: rgba(76, 175, 80, 0.1);
            color: var(--accent-green);
        }

        .role-badge.admin {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }

        .status-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-small);
            font-weight: 500;
        }

        .status-badge.active {
            background: rgba(76, 175, 80, 0.1);
            color: var(--accent-green);
        }

        .status-badge.inactive {
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .action-btn {
            padding: var(--spacing-xs);
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s ease;
            margin-right: var(--spacing-xs);
        }

        .action-btn:hover {
            background: var(--light-gray);
        }

        .action-btn.edit {
            color: var(--primary-blue);
        }

        .action-btn.delete {
            color: #f44336;
        }

        .pagination-container {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-info {
            font-size: var(--font-size-small);
            color: #666;
        }

        .pagination-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .pagination-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: var(--light-gray);
        }

        .pagination-btn.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal-content {
            max-width: 500px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: #666;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }



        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .users-table {
                font-size: var(--font-size-small);
            }
            
            .users-table th,
            .users-table td {
                padding: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="hamburger" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="header-logo">üìö EduPlatform</div>
        </div>
        <div class="header-right">
            <div class="header-user" id="userInfo">
                <div class="header-avatar" id="userAvatar">A</div>
                <div class="header-user-info">
                    <span class="header-username" id="userName">Admin</span>
                    <span class="header-role" id="userRole">Qu·∫£n tr·ªã vi√™n</span>
                </div>
            </div>
            <button class="theme-toggle" onclick="window.themeManager?.toggleTheme()" title="Chuy·ªÉn ƒë·ªïi giao di·ªán">
                <span class="theme-icon">üåô</span>
            </button>
            <button class="btn btn-secondary btn-small" onclick="authManager.logout()">
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar sidebar-fixed" id="sidebar">
            <div class="sidebar-nav" id="sidebarNav">
                <!-- Navigation will be populated based on user role -->
            </div>
        </nav>

        <!-- Content -->
        <main class="content main-content" id="content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="userManager.showAddModal()">
                        ‚ûï Th√™m ng∆∞·ªùi d√πng
                    </button>
                    <button class="btn btn-secondary" onclick="userManager.exportUsers()">
                        üì§ Xu·∫•t danh s√°ch
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="form-group">
                        <label class="form-label">T√¨m ki·∫øm</label>
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="form-control" 
                            placeholder="T√¨m theo t√™n, email, username..."
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vai tr√≤</label>
                        <select id="roleFilter" class="form-control">
                            <option value="">T·∫•t c·∫£ vai tr√≤</option>
                            <option value="student">H·ªçc vi√™n</option>
                            <option value="teacher">Gi·∫£ng vi√™n</option>
                            <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select id="statusFilter" class="form-control">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="active">Ho·∫°t ƒë·ªông</option>
                            <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="userManager.clearFilters()">
                            üîÑ X√≥a b·ªô l·ªçc
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Danh s√°ch ng∆∞·ªùi d√πng</div>
                    <div class="table-count" id="userCount">T·ªïng: 0 ng∆∞·ªùi d√πng</div>
                </div>

                <div class="table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Ng∆∞·ªùi d√πng</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Ho·∫°t ƒë·ªông cu·ªëi</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info" id="paginationInfo">
                        Hi·ªÉn th·ªã 1-10 trong t·ªïng s·ªë 0 k·∫øt qu·∫£
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Pagination buttons will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
                <button class="modal-close" onclick="uiManager.hideModal(document.getElementById('userModal'))">&times;</button>
            </div>
            <div class="modal-body">
                <form class="modal-form" id="userForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n *</label>
                            <input type="text" id="modalFullName" class="form-control" required>
                            <div class="form-error" id="modalFullNameError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">T√™n ƒëƒÉng nh·∫≠p *</label>
                            <input type="text" id="modalUsername" class="form-control" required>
                            <div class="form-error" id="modalUsernameError"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="modalEmail" class="form-control" required>
                            <div class="form-error" id="modalEmailError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vai tr√≤ *</label>
                            <select id="modalRole" class="form-control" required>
                                <option value="">Ch·ªçn vai tr√≤</option>
                                <option value="student">H·ªçc vi√™n</option>
                                <option value="teacher">Gi·∫£ng vi√™n</option>
                                <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                            </select>
                            <div class="form-error" id="modalRoleError"></div>
                        </div>
                    </div>

                    <div class="form-row single" id="passwordRow">
                        <div class="form-group">
                            <label class="form-label">M·∫≠t kh·∫©u *</label>
                            <input type="password" id="modalPassword" class="form-control" required>
                            <div class="form-error" id="modalPasswordError"></div>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">M·ª•c ti√™u h·ªçc t·∫≠p</label>
                            <textarea id="modalGoal" class="form-control" rows="3" placeholder="M√¥ t·∫£ m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa ng∆∞·ªùi d√πng..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="uiManager.hideModal(document.getElementById('userModal'))">
                    H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="userManager.saveUser()">
                    <span id="saveButtonText">Th√™m ng∆∞·ªùi d√πng</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <p>&copy; 2025 E-Learning Platform. Ph√°t tri·ªÉn b·ªüi <strong>T√πng Huynh</strong> üé®üíª</p>
    </footer>

    <!-- JavaScript -->
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.filteredUsers = [];
                this.currentPage = 1;
                this.usersPerPage = 10;
                this.editingUserId = null;
                this.permissions = {};
                
                this.init();
            }

            async init() {
                // Check authentication
                if (!authManager.checkPageAccess(['admin', 'teacher'])) {
                    return;
                }

                this.currentUser = authManager.getCurrentUser();
                this.setupRolePermissions();
                this.updateUserInfo();
                this.bindEvents();
                
                await this.loadUsers();
                this.renderUsers();
            }

            setupRolePermissions() {
                // Define permissions based on user role
                if (this.currentUser.role === 'admin') {
                    this.permissions = {
                        canViewAllUsers: true,
                        canCreateUser: true,
                        canEditUser: true,
                        canDeleteUser: true,
                        canChangeUserRole: true,
                        canManageTeachers: true,
                        canManageStudents: true,
                        canManageAdmins: true,
                        canExportData: true,
                        canImportData: true
                    };
                } else if (this.currentUser.role === 'teacher') {
                    this.permissions = {
                        canViewAllUsers: false, // Only students in their classes
                        canCreateUser: false,
                        canEditUser: false, // Only basic info of their students
                        canDeleteUser: false,
                        canChangeUserRole: false,
                        canManageTeachers: false,
                        canManageStudents: true, // Limited to their classes
                        canManageAdmins: false,
                        canExportData: false,
                        canImportData: false
                    };
                }

                // Update UI based on permissions
                this.updateUIPermissions();
            }

            updateUIPermissions() {
                // Hide/show buttons based on permissions
                const addUserBtn = document.querySelector('.btn-primary');
                if (addUserBtn && !this.permissions.canCreateUser) {
                    addUserBtn.style.display = 'none';
                }

                const importBtn = document.querySelector('button[onclick*="importUsers"]');
                if (importBtn && !this.permissions.canImportData) {
                    importBtn.style.display = 'none';
                }

                const exportBtn = document.querySelector('button[onclick*="exportUsers"]');
                if (exportBtn && !this.permissions.canExportData) {
                    exportBtn.style.display = 'none';
                }

                // Update page title for teachers
                if (this.currentUser.role === 'teacher') {
                    document.querySelector('.page-title').textContent = 'üë• Qu·∫£n l√Ω H·ªçc vi√™n';
                }
            }

            bindEvents() {
                // Hamburger menu
                document.getElementById('hamburgerBtn').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                // Search and filters
                document.getElementById('searchInput').addEventListener('input', () => {
                    this.filterUsers();
                });

                document.getElementById('roleFilter').addEventListener('change', () => {
                    this.filterUsers();
                });

                document.getElementById('statusFilter').addEventListener('change', () => {
                    this.filterUsers();
                });

                // Form submission
                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveUser();
                });
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const content = document.getElementById('content');
                const footer = document.getElementById('footer');

                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('mobile-open');
                } else {
                    sidebar.classList.toggle('collapsed');
                    content.classList.toggle('sidebar-collapsed');
                    footer.classList.toggle('sidebar-collapsed');
                }
            }

            updateUserInfo() {
                if (this.currentUser) {
                    document.getElementById('userName').textContent = this.currentUser.fullName || this.currentUser.username;
                // Update user role display
                const currentUser = authManager.getCurrentUser();
                if (currentUser) {
                    const roleMap = {
                        'admin': ' Qu·∫£n tr·ªã vi√™n',
                        'teacher': ' Gi·∫£ng vi√™n', 
                        'student': ' H·ªçc vi√™n'
                    };
                    document.getElementById('userRole').textContent = roleMap[currentUser.role] || ' User';
                }
                    document.getElementById('userAvatar').textContent = this.currentUser.fullName ? this.currentUser.fullName.charAt(0).toUpperCase() : 'U';
                }
            }

            async loadUsers() {
                try {
                    this.users = await authManager.loadUsers();
                    
                    // If teacher, only show students
                    if (this.currentUser.role === 'teacher') {
                        this.users = this.users.filter(user => user.role === 'student');
                    }
                    
                    this.filteredUsers = [...this.users];
                } catch (error) {
                    console.error('Error loading users:', error);
                    uiManager.showToast('C√≥ l·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng', 'error');
                }
            }

            filterUsers() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const roleFilter = document.getElementById('roleFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                this.filteredUsers = this.users.filter(user => {
                    const matchesSearch = !searchTerm || 
                        user.fullName?.toLowerCase().includes(searchTerm) ||
                        user.email?.toLowerCase().includes(searchTerm) ||
                        user.username?.toLowerCase().includes(searchTerm);
                    
                    const matchesRole = !roleFilter || user.role === roleFilter;
                    
                    // Mock status - in real app would check last login, etc.
                    const userStatus = Math.random() > 0.2 ? 'active' : 'inactive';
                    const matchesStatus = !statusFilter || userStatus === statusFilter;

                    return matchesSearch && matchesRole && matchesStatus;
                });

                this.currentPage = 1;
                this.renderUsers();
            }

            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('roleFilter').value = '';
                document.getElementById('statusFilter').value = '';
                this.filterUsers();
            }

            renderUserActions(user) {
                let actions = [];

                // View action (always available)
                actions.push(`<button class="action-btn view" onclick="userManager.viewUser(${user.id})" title="Xem chi ti·∫øt">üëÅÔ∏è</button>`);

                // Edit action (based on permissions)
                if (this.canEditUser(user)) {
                    actions.push(`<button class="action-btn edit" onclick="userManager.editUser(${user.id})" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>`);
                }

                // Delete action (based on permissions)
                if (this.canDeleteUser(user)) {
                    actions.push(`<button class="action-btn delete" onclick="userManager.deleteUser(${user.id})" title="X√≥a">üóëÔ∏è</button>`);
                }

                return actions.join(' ');
            }

            canEditUser(user) {
                if (this.currentUser.role === 'admin') {
                    return this.permissions.canEditUser;
                } else if (this.currentUser.role === 'teacher') {
                    // Teachers can only edit students, not other teachers or admins
                    return user.role === 'student' && this.permissions.canManageStudents;
                }
                return false;
            }

            canDeleteUser(user) {
                if (this.currentUser.role === 'admin') {
                    // Admins can delete anyone except themselves
                    return this.permissions.canDeleteUser && user.id !== this.currentUser.id;
                } else if (this.currentUser.role === 'teacher') {
                    // Teachers cannot delete users
                    return false;
                }
                return false;
            }

            renderUsers() {
                const tbody = document.getElementById('usersTableBody');
                const startIndex = (this.currentPage - 1) * this.usersPerPage;
                const endIndex = startIndex + this.usersPerPage;
                const pageUsers = this.filteredUsers.slice(startIndex, endIndex);

                // Update count
                document.getElementById('userCount').textContent = `T·ªïng: ${this.filteredUsers.length} ng∆∞·ªùi d√πng`;

                if (pageUsers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-icon">üë•</div>
                                <p>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</p>
                            </td>
                        </tr>
                    `;
                    this.renderPagination();
                    return;
                }

                const usersHTML = pageUsers.map(user => {
                    const userStatus = Math.random() > 0.2 ? 'active' : 'inactive';
                    const statusText = userStatus === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông';
                    const lastActivity = this.getRandomDate();
                    
                    return `
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${user.fullName ? user.fullName.charAt(0).toUpperCase() : user.username.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="user-details">
                                        <div class="user-name">${user.fullName || user.username}</div>
                                        <div class="user-email">${user.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="role-badge ${user.role}">
                                    ${this.getRoleDisplay(user.role)}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${userStatus}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${uiManager.formatDate(user.createdAt || '2024-01-01')}</td>
                            <td>${uiManager.formatDateTime(lastActivity)}</td>
                            <td class="actions-cell">
                                ${this.renderUserActions(user)}
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = usersHTML;
                this.renderPagination();
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredUsers.length / this.usersPerPage);
                const startIndex = (this.currentPage - 1) * this.usersPerPage + 1;
                const endIndex = Math.min(startIndex + this.usersPerPage - 1, this.filteredUsers.length);

                // Update pagination info
                document.getElementById('paginationInfo').textContent = 
                    `Hi·ªÉn th·ªã ${startIndex}-${endIndex} trong t·ªïng s·ªë ${this.filteredUsers.length} k·∫øt qu·∫£`;

                // Update pagination controls
                const controls = document.getElementById('paginationControls');
                let paginationHTML = '';

                // Previous button
                paginationHTML += `
                    <button class="pagination-btn" ${this.currentPage === 1 ? 'disabled' : ''} 
                            onclick="userManager.goToPage(${this.currentPage - 1})">
                        ‚Äπ Tr∆∞·ªõc
                    </button>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" 
                                    onclick="userManager.goToPage(${i})">
                                ${i}
                            </button>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        paginationHTML += '<span class="pagination-ellipsis">...</span>';
                    }
                }

                // Next button
                paginationHTML += `
                    <button class="pagination-btn" ${this.currentPage === totalPages ? 'disabled' : ''} 
                            onclick="userManager.goToPage(${this.currentPage + 1})">
                        Sau ‚Ä∫
                    </button>
                `;

                controls.innerHTML = paginationHTML;
            }

            goToPage(page) {
                const totalPages = Math.ceil(this.filteredUsers.length / this.usersPerPage);
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderUsers();
                }
            }

            showAddModal() {
                // Check permissions
                if (!this.permissions.canCreateUser) {
                    uiManager.showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o ng∆∞·ªùi d√πng m·ªõi', 'error');
                    return;
                }

                this.editingUserId = null;
                document.getElementById('modalTitle').textContent = 'Th√™m ng∆∞·ªùi d√πng m·ªõi';
                document.getElementById('saveButtonText').textContent = 'Th√™m ng∆∞·ªùi d√πng';
                document.getElementById('passwordRow').style.display = 'block';
                this.clearModalForm();
                
                // Enable all fields for admin
                document.getElementById('modalRole').disabled = false;
                
                uiManager.showModal('userModal');
            }

            viewUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                // Create view-only modal content
                const userInfo = `
                    <div style="padding: var(--spacing-lg);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-blue); color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                                ${(user.fullName || user.username).charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 style="margin: 0; margin-bottom: var(--spacing-xs);">${user.fullName || user.username}</h3>
                                <span class="role-badge ${user.role}">${this.getRoleDisplay(user.role)}</span>
                            </div>
                        </div>
                        <div style="display: grid; gap: var(--spacing-md);">
                            <div><strong>Username:</strong> ${user.username}</div>
                            <div><strong>Email:</strong> ${user.email}</div>
                            <div><strong>Vai tr√≤:</strong> ${this.getRoleDisplay(user.role)}</div>
                            <div><strong>Ng√†y t·∫°o:</strong> ${uiManager.formatDate(user.createdAt || '2024-01-01')}</div>
                            ${user.goal ? `<div><strong>M·ª•c ti√™u:</strong> ${user.goal}</div>` : ''}
                        </div>
                    </div>
                `;

                uiManager.showModal('alertModal', 'Th√¥ng tin ng∆∞·ªùi d√πng', userInfo);
            }

            editUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                // Check permissions
                if (!this.canEditUser(user)) {
                    uiManager.showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a ng∆∞·ªùi d√πng n√†y', 'error');
                    return;
                }

                this.editingUserId = userId;
                document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng';
                document.getElementById('saveButtonText').textContent = 'C·∫≠p nh·∫≠t';
                document.getElementById('passwordRow').style.display = 'none';

                // Populate form
                document.getElementById('modalFullName').value = user.fullName || '';
                document.getElementById('modalUsername').value = user.username || '';
                document.getElementById('modalEmail').value = user.email || '';
                document.getElementById('modalRole').value = user.role || '';
                document.getElementById('modalGoal').value = user.goal || '';

                // Disable role field for teachers
                if (this.currentUser.role === 'teacher') {
                    document.getElementById('modalRole').disabled = true;
                } else {
                    document.getElementById('modalRole').disabled = false;
                }

                uiManager.showModal('userModal');
            }

            async saveUser() {
                const formData = {
                    fullName: document.getElementById('modalFullName').value.trim(),
                    username: document.getElementById('modalUsername').value.trim(),
                    email: document.getElementById('modalEmail').value.trim(),
                    role: document.getElementById('modalRole').value,
                    goal: document.getElementById('modalGoal').value.trim()
                };

                if (this.editingUserId === null) {
                    formData.password = document.getElementById('modalPassword').value;
                }

                // Validation
                if (!this.validateUserForm(formData)) {
                    return;
                }

                try {
                    if (this.editingUserId === null) {
                        // Add new user
                        const result = await authManager.register(formData);
                        if (result.success) {
                            uiManager.showToast('Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
                            await this.loadUsers();
                            this.renderUsers();
                            uiManager.hideModal(document.getElementById('userModal'));
                        } else {
                            uiManager.showToast(result.error, 'error');
                        }
                    } else {
                        // Update existing user
                        const users = await authManager.loadUsers();
                        const userIndex = users.findIndex(u => u.id === this.editingUserId);
                        
                        if (userIndex !== -1) {
                            users[userIndex] = { ...users[userIndex], ...formData };
                            localStorage.setItem('users', JSON.stringify(users));
                            
                            uiManager.showToast('C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
                            await this.loadUsers();
                            this.renderUsers();
                            uiManager.hideModal(document.getElementById('userModal'));
                        }
                    }
                } catch (error) {
                    console.error('Error saving user:', error);
                    uiManager.showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u ng∆∞·ªùi d√πng', 'error');
                }
            }

            validateUserForm(data) {
                let isValid = true;

                // Clear previous errors
                this.clearModalErrors();

                if (!data.fullName) {
                    this.showModalError('modalFullNameError', 'Vui l√≤ng nh·∫≠p h·ªç v√† t√™n');
                    isValid = false;
                }

                if (!data.username) {
                    this.showModalError('modalUsernameError', 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p');
                    isValid = false;
                }

                if (!data.email) {
                    this.showModalError('modalEmailError', 'Vui l√≤ng nh·∫≠p email');
                    isValid = false;
                } else if (!uiManager.validateEmail(data.email)) {
                    this.showModalError('modalEmailError', 'Email kh√¥ng h·ª£p l·ªá');
                    isValid = false;
                }

                if (!data.role) {
                    this.showModalError('modalRoleError', 'Vui l√≤ng ch·ªçn vai tr√≤');
                    isValid = false;
                }

                if (this.editingUserId === null && !data.password) {
                    this.showModalError('modalPasswordError', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
                    isValid = false;
                } else if (this.editingUserId === null && data.password.length < 6) {
                    this.showModalError('modalPasswordError', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
                    isValid = false;
                }

                return isValid;
            }

            deleteUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                // Check permissions
                if (!this.canDeleteUser(user)) {
                    uiManager.showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a ng∆∞·ªùi d√πng n√†y', 'error');
                    return;
                }

                uiManager.showConfirm(
                    `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${user.fullName || user.username}"?`,
                    async () => {
                        try {
                            const users = await authManager.loadUsers();
                            const filteredUsers = users.filter(u => u.id !== userId);
                            localStorage.setItem('users', JSON.stringify(filteredUsers));
                            
                            // Log activity
                            authManager.logActivity('User Deleted', `Deleted user: ${user.fullName || user.username} (${user.email})`);
                            
                            uiManager.showToast('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
                            await this.loadUsers();
                            this.renderUsers();
                        } catch (error) {
                            console.error('Error deleting user:', error);
                            uiManager.showToast('C√≥ l·ªói x·∫£y ra khi x√≥a ng∆∞·ªùi d√πng', 'error');
                        }
                    }
                );
            }

            exportUsers() {
                // Mock export functionality
                uiManager.showToast('ƒêang xu·∫•t danh s√°ch ng∆∞·ªùi d√πng...', 'info');
                setTimeout(() => {
                    uiManager.showToast('Xu·∫•t danh s√°ch th√†nh c√¥ng! File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.', 'success');
                }, 2000);
            }

            clearModalForm() {
                document.getElementById('userForm').reset();
                this.clearModalErrors();
            }

            clearModalErrors() {
                const errorElements = ['modalFullNameError', 'modalUsernameError', 'modalEmailError', 'modalRoleError', 'modalPasswordError'];
                errorElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = 'none';
                        element.textContent = '';
                    }
                });
            }

            showModalError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }

            getRoleDisplay(role) {
                const roleMap = {
                    'student': 'H·ªçc vi√™n',
                    'teacher': 'Gi·∫£ng vi√™n',
                    'admin': 'Qu·∫£n tr·ªã vi√™n'
                };
                return roleMap[role] || role;
            }

            getRandomDate() {
                const start = new Date(2024, 0, 1);
                const end = new Date();
                return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime())).toISOString();
            }
        }

        // Initialize user manager when DOM is loaded
        let userManager;
        document.addEventListener('DOMContentLoaded', () => {
            userManager = new UserManager();
        });
    </script>

    <!-- Components -->
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/components/menu-manager.js"></script>
</body>
</html> 

